function updateStdTaskTable(send){var requester;switch($("#modal-write-requester").val()){case"dedicated-student":hideSaveBtn();break;case"all-tasks":case"task-manager":var stdTaskId=parseInt($("#modal-std-task-id").val()),currentData=$("#send-std-grades").data("send");if(null==currentData)return!1;if(send){var index=$.inArray(stdTaskId,currentData);index>=0&&currentData.splice(index,1),$("#send-std-grades").data("send",currentData).attr("data-send",JSON.stringify(currentData)),0==currentData.length&&$("#send-std-grades").addClass("disabled"),hideSaveBtn()}else $.inArray(stdTaskId,currentData)<0&&currentData.push(stdTaskId),$("#send-std-grades").data("send",currentData).attr("data-send",JSON.stringify(currentData)).removeClass("disabled");var taskId=$("#modal-write-std").val(),row=$("#reports-panel").find("#task-write-"+taskId);send?row.find("td.status").html('<i class="fa fa-paper-plane" title="Grade sent to student" style="font-size: 14px; color: #5bb75b;"></i>'):row.find("td.status").html('<i class="fa fa-floppy-o" title="Grade saved" style="font-size: 14px; font-weight: bold; color: #333;"></i>')}}function hideSaveBtn(){$("#modal-task-status").html('<i class="fa fa-paper-plane" style="color: #128f76;"></i> Sent'),$("#modal-write-save").parent("div").removeClass("btn-group"),$("#modal-write-save").hide()}function saveThread(container){var thread=container;if(thread.val().length>0){var father=thread.data("father"),content=thread.val(),instructor=$("#modal-write-instructor").val(),url="/pages/std-access/std-written-tasks-actions.php",data={action:"save-thread",ticket:$("#ticket").val(),"std-task-id":$("#modal-std-task-id").val(),"user-type":$("#modal-write-user-type").val(),log:$("#modal-write-std-log").val(),subject:$("#modal-write-general-id").val(),std:$("#modal-write-std").val(),father:father,content:content};$.post(url,data,(function(response){1==response.success?($(".thread-list").is(":empty")&&$(".thread-list").css({border:"1px solid #e3e3e3",padding:"5px","overflow-y":"auto"}),$(".thread-list").append(['<div class="thread-'+response.id+'" data-sent="0" style="background-color: #f5f5f5;">','<div class="comment-content">',"<strong><small>"+instructor+"</small></strong>",'<a class="delete-thread" href="#" ','style="margin-left: 10px;" ','title="Delete this comment" ','data-thread-id="'+response.id+'">','<i class="fa fa-trash-o red"></i>',"</a>",response.created,'<img class="userpic thumb pull-left" src="'+response.userpic+'">','<div class="thread-content">'+nl2br(content)+"</div>","</div>","</div>"].join("")),$("textarea#student-msg").val(""),update_local_dates($(".thread-list"))):alert(response.msg)}),"json")}}function saveGrade(container){if(""!=getGrade())return alert(getGrade()),!1;var requester=$("#modal-write-requester").val(),stdId=$("#modal-write-std").val(),log=$("#modal-write-std-log").val(),taskId=null,stdTaskId=null;switch(requester){case"dedicated-student":stdTaskId=$("#modal-std-task-id").val(),taskId=$('a[data-tsid="'+stdTaskId+'"]').closest("tr").data("task");break;case"gradebook":case"std-access-dashboard":taskId=$("#modal-write-task-id").val();break;case"all-tasks":case"task-manager":taskId=$("#task-id").val()}var url="/pages/std-access/std-written-tasks-actions.php",data={action:"save-grade",ticket:$("#ticket").val(),subject:$("#modal-write-general-id").val(),mark:$("#modal-mark-score").val(),score:$("#modal-write-score").val(),send:!1,log:log,std:stdId,task_id:taskId};$.post(url,data,(function(response){if(1==response.success){var row=null;switch(requester){case"dedicated-student":(row=$("#awaiting-assignments-container").find("tr#task-"+taskId)).find("td.score").html(`\n              <a class="std-task-action load-std-report" href="#" \n                data-tsid="${stdTaskId}" \n                data-wtid="${log}" \n                title="Open student task report">\n                  <strong>${response.grade}</strong>\n              </a>\n            `),row.find("td.status").html('\n              <i class="fa fa-floppy-o" title="Grade saved" \n                style="font-size: 14px; font-weight: bold; color: #333">\n              </i>\n            ');break;case"all-tasks":case"task-manager":if(row=$("#reports-panel").find("#task-write-"+stdId),void 0!==visitsLog[stdId]){var showReview=row.find("td.score > a.show-review");row.find("td.score").html(`\n                <a class="show-review" href="#" title="Open task report" \n                  data-tsid="${showReview.data("tsid")}"\n                  data-std-id="${stdId}" \n                  data-std-name="${showReview.data("std-name")}" \n                  data-status="${showReview.data("status")}" \n                  data-std-email="${showReview.data("std-email")}" \n                  data-avg-time="${showReview.data("avg-time")}" \n                  data-total-time="${showReview.data("total-time")}">\n                  <strong>${response.grade}</strong>\n                </a>\n              `),visitsLog[stdId].score=response.grade}}$("#modal-write-save").attr("disabled",!0),showSuccessMessage($(".comment-box-msg"),"Changes successfully saved")}else alert(response.msg)}),"json")}function sendThreads(container){var savedThreads=getSavedThreads(container),newThread=[],instructor=$("#modal-write-instructor").val();if(container.find("textarea#student-msg").val().length>0){var thread={father:$("textarea#student-msg").data("father"),content:$("textarea#student-msg").val()};newThread.push(thread)}if(newThread.length>0||savedThreads.length>0){var url="/pages/std-access/std-written-tasks-actions.php",data={action:"send-threads",ticket:$("#ticket").val(),std:$("#modal-write-std").val(),log:$("#modal-write-std-log").val(),subject:$("#modal-write-general-id").val(),"user-type":$("#modal-write-user-type").val(),"std-task-id":$("#modal-std-task-id").val(),"saved-threads":savedThreads.length>0?savedThreads:null,thread:newThread.length>0?newThread:null};$.post(url,data,(function(response){if(1==response.success){$(".thread-list").is(":empty")&&$(".thread-list").css({border:"1px solid #e3e3e3",padding:"5px","overflow-y":"auto"}),$.each(savedThreads,(function(i,s){var id=s,thread;container.find(".thread-"+id).attr("data-sent","1")}));var threads=response.threads;threads.length>0&&$.each(threads,(function(i,t){$(".thread-list").append(['<div class="thread-'+t.id+'" data-sent="0" style="background-color: #f5f5f5;">','<div class="comment-content">',"<strong><small>"+instructor+"</small></strong>",'<a class="delete-thread" href="#" ','style="margin-left: 10px;" ','title="Delete this comment" ','data-thread-id="'+t.id+'">','<i class="fa fa-trash-o red"></i>',"</a>",t.created,'<img class="userpic thumb pull-left" src="'+t.userpic+'">','<div class="thread-content">'+nl2br(t.content)+"</div>","</div>","</div>"].join(""))})),$("textarea#student-msg").val(""),update_local_dates($(".thread-list"))}else alert(response.msg)}),"json")}}function sendGrade(container){if(""!=getGrade())return alert(getGrade()),!1;var requester=$("#modal-write-requester").val(),stdId=$("#modal-write-std").val(),log=$("#modal-write-std-log").val(),taskId=null,stdTaskId=null;switch(requester){case"dedicated-student":stdTaskId=$("#modal-std-task-id").val(),taskId=$('a[data-tsid="'+stdTaskId+'"]').closest("tr").data("task");break;case"gradebook":case"std-access-dashboard":taskId=$("#modal-write-task-id").val();break;case"all-tasks":case"task-manager":taskId=$("#task-id").val()}var url="/pages/std-access/std-written-tasks-actions.php",data={action:"send-grade",ticket:$("#ticket").val(),subject:$("#modal-write-general-id").val(),mark:$("#modal-mark-score").val(),score:$("#modal-write-score").val(),send:!0,log:log,std:stdId,task_id:taskId};$.post(url,data,(function(response){if(1==response.success){switch(requester){case"dedicated-student":reloadLocation=!0;break;case"all-tasks":case"task-manager":if(void 0!==visitsLog[stdId]){var row=$("#reports-panel").find("#task-write-"+stdId),showReview=row.find("td.score > a.show-review");row.find("td.score").html(`\n                <a class="show-review" href="#" title="Open task report" \n                  data-tsid="${showReview.data("tsid")}" \n                  data-std-id="${stdId}" \n                  data-std-name="${showReview.data("std-name")}" \n                  data-status="${showReview.data("status")}" \n                  data-std-email="${showReview.data("std-email")}" \n                  data-avg-time="${showReview.data("avg-time")}" \n                  data-total-time="${showReview.data("total-time")}">\n                  <strong>${response.grade}</strong>\n                </a>\n              `),visitsLog[stdId].score=response.grade}break;case"gradebook":var grade=response.grade.replace(/<\/?strong>/g,"").replace("%",""),late="";response.late&&(late="score-late");var th=$("#students-scrollable-table > thead").find('th[data-task="'+taskId+'"]'),tr;$("#students-scrollable-table > tbody").find('tr[data-student="'+stdId+'"]').find("td").eq(th.index()).html(['<div class="'+late+'">',grade,'<ul class="float-menu" style="display: none;">','<li><a class="open-task-report" href="#"><i class="fa fa-fw fa-bar-chart"></i> ',"Open task report</a>","</li>",'<li><a class="reset-task-student" href="#"><i class="fa fa-fw fa-undo"></i> ',"Reset task for the student</a>","</li>","</ul>","</div>"].join(""))}$("#modal-write-send").attr("disabled",!0),hideSaveBtn(),showSuccessMessage($(".comment-box-msg"),"Changes successfully sent")}else alert(response.msg)}),"json")}function deleteThreadComment(id){var threadId=id,url="/pages/std-access/std-written-tasks-actions.php",data={action:"destroy-thread",ticket:$("#ticket").val(),thread_id:threadId};$.post(url,data,(function(response){if(1==response.success){var deleted=JSON.parse(response.deleted);$.each(deleted,(function(i,threadId){var thread;$(".thread-"+threadId).fadeOut("fast",(function(){$(this).remove(),$(".thread-list").is(":empty")&&$(".thread-list").css({border:"none",padding:"0","overflow-y":"unset"})}))}))}else alert(response.msg)}),"json")}function saveTeacherPrivateNotes(){var url="/pages/std-access/std-written-tasks-actions.php",data={action:"save-private-notes",ticket:$("#ticket").val(),subject:$("#modal-write-general-id").val(),log:$("#modal-write-std-log").val(),std:$("#modal-write-std").val(),notes:$("#modal-write-teacher-notes").val()};$.post(url,data,(function(response){1==response.success?($("#modal-write-save-private-notes").attr("disabled",!0),showSuccessMessage($(".private-notes-box-msg"),"Private notes successfully saved")):alert(response.msg)}),"json")}function getSavedThreads(element){var ids=[],threads=element.find('.thread-list div[class^="thread-"][data-sent="0"]');return threads.length>0&&$.each(threads,(function(i,t){var id=$(t).attr("class").split("-").pop();ids.push(id)})),ids}function getGrade(){var error="";if("percentage"===$("#modal-select-score-type").val()){var percentageScore=$("#modal-write-score-percentage").val();percentageScore.length>0&&$.isNumeric(percentageScore)&&((percentageScore=parseInt(percentageScore))>=0&&percentageScore<=100?($("#modal-mark-score").val(""),$("#modal-write-score").val(percentageScore)):error="Please write a number between 0 and 100")}else{var firstN=$("#modal-write-score-points1").val(),secondN=$("#modal-write-score-points2").val();if(firstN.length>0&&secondN.length>0&&$.isNumeric(firstN)&&$.isNumeric(secondN))if((firstN=parseInt(firstN))>(secondN=parseInt(secondN)))error="Grade mark is not well formatted";else if(firstN>=0&&firstN<=25&&secondN>0&&secondN<=25){var pointsScore=Math.floor(firstN/secondN*100);$("#modal-mark-score").val(firstN+"/"+secondN),$("#modal-write-score").val(pointsScore)}else error="Please write the numbers between 0 and 25"}return error}function nl2br(str,is_xhtml){var breakTag;return(str+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(is_xhtml||void 0===is_xhtml?"<br />":"<br>")+"$2")}